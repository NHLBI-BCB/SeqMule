#!/usr/bin/env perl

use strict;
use warnings;
use File::Spec;
use FindBin qw/$RealBin/;
use lib File::Spec->catdir($RealBin,"..","..","lib");
use SeqMule::Parallel;
use SeqMule::Utils;
use Pod::Usage qw/pod2usage/;
use Getopt::Long qw/GetOptions/;

my ($advanced,$n,$help,
    $snap,$samtools,$sortmem,$java,$jmem,$sortsam,$ref,$bam,$threads,$rg,$sample,$pl,$lb);
#check tmpdir beforeuse!!!!
my $tmpdir;
@ARGV or pod2usage ({-exitval=>2});
GetOptions(
    #input and output
    'snap=s'		=>	\$snap,
    'samtools=s'	=>	\$samtools,
    'sortmem=s'		=>	\$sortmem,
    'java=s'		=>	\$java,
    'jmem=s'		=>	\$jmem,
    'sortsam=s'		=>	\$sortsam,
    'ref=s'		=>	\$ref,
    'bam=s'		=>	\$bam,
    'threads=i'		=>	\$threads,
    'rg=s'		=>	\$rg,
    'sample=s'		=>	\$sample,
    'pl=s'		=>	\$pl,
    'lb=s'		=>	\$lb,
    'advanced=s'	=>	\$advanced,
    'n=i'		=>	\$n,
    'tmpdir=s'		=>	\$tmpdir,
    #other
    'help|h'	        =>	\$help,
) or pod2usage({-exitval => 2});
$help and pod2usage ({-verbose=>1});

my @fq=@ARGV;
my @steps=&SeqMule::Utils::parsePipeline($advanced);
my %options=%{ $steps[$n-1][2] };
#my $tmpbam = File::Spec->catfile($tmpdir,$$.rand($$)."_snap.bam");
my $tmpbam = File::Spec->catfile(".",$$.rand($$)."_snap.bam");
$bam=~/(.*?)\.bam$/ or die "ERROR: expect *.bam for BAM files: $bam\n";
my $prefix_bam = $1;

&SeqMule::Utils::checkOrCreateTmpdir($tmpdir);

my $cmd;
my @cmd;

$cmd .= "$snap ";
$cmd .= (@fq==2? " paired ":" single "); 
$cmd .= " $ref @fq "; 
$cmd .= " -F a "; #only output aligned reads
$cmd .= " -h $options{singleMaxHits} " if $options{singleMaxHits} ne '';
$cmd .= " -H $options{pairMaxHits} " if $options{pairMaxHits} ne '';
$cmd .= " -d $options{maxDist} " if $options{maxDist} ne '';
$cmd .= " -s $options{readSpacingMin} $options{readSpacingMax} " if $options{readSpacingMin} ne '' && $options{readSpacingMax} ne '';
$cmd .=($threads >= 2? " -t $threads" : "");
$cmd .= " -R '\@RG\\tID:$rg\\tSM:$sample\\tPL:$pl\\tLB:$lb' ";
$cmd .= " $options{additional} " if $options{additional} ne '';
$cmd .= " -o -bam $tmpbam"; #pipe output to samtools, by default, this should be SAM format
push @cmd,$cmd;
$cmd = '';

$cmd .= " $samtools view -b ";
$cmd.=" -F 256 "; #only output primary alignment
$cmd .=($threads >= 2? " -@ $threads" : "");
$cmd .= " $tmpbam | $samtools sort ".($sortmem?" -m $sortmem":"").($threads>=2? " -@ $threads":"")." - $prefix_bam";
push @cmd,$cmd;
$cmd = '';

push @cmd,"rm $tmpbam";

my $script=&SeqMule::Parallel::genTempScript(@cmd);
exec $script;


__END__


=head1 NAME

SeqMule an automatic pipeline for next-generation sequencing data analysis

=head1 SYNOPSIS

Options:


=head1 OPTIONS

=over 8

=item B<--help>

Show detaild help.

=back

=head1 DESCRIPTION

SeqMule automatizes analysis of next-generation sequencing data by simplifying program installation, downloading of various databases, generation of analysis script, and customization of your pipeline.

=cut
