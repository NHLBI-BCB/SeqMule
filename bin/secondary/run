#!/usr/bin/env perl

#Copyright (C) <2012>  <Yunfei Guo>

#This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

#This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

#You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.


use warnings;
use strict;
use FindBin qw/$RealBin/;
use File::Spec;
use lib File::Spec->catdir($RealBin,"..","..","lib");
use SeqMule::Parallel;
use Pod::Usage qw/pod2usage/;
use Getopt::Long qw/GetOptions/;


my $install_dir=File::Spec->catdir($RealBin,"..","..");
my (
    $sge,$help,$script,$step,
);
#------------------------------------------------------------------------------------------------

@ARGV or pod2usage ({-exitval=>2,-verbose=>1});
GetOptions(
    #input and output
    'sge=s'		=>	\$sge,
    'n=i'		=>	\$step,
    #other
    'help|h'	        =>	\$help,
) or pod2usage({-exitval => 2,-verbose=>1});
$help and pod2usage ({-verbose=>2});

die "ERROR: Script file missing or more than one arguments specified.\n" unless @ARGV==1;
$script=shift @ARGV;
$SIG{INT} = sub{ &SeqMule::Parallel::stop($script,$sge) };
warn "Execute via Sun Grid Engine (SGE).\n" if $sge;
&SeqMule::Parallel::run($script,$step,$sge);

__END__


=head1 NAME

seqmule-run executes an analysis script

=head1 SYNOPSIS

	seqmule run <script_file> [options]

=head1 DESCRIPTION

This command takes a script file generated by seqmule-pipelien and executes it from the first step among all unfinished steps.

=head1 OPTIONS

	-n <INT>		run from step INT
	--sge <TEXT>		run each command via Sun Grid Engine. A template with XCPUX keyword is expected.
	-h,--help		help

=head1 EXAMPLES

      	#continue run from last executed step
      	seqmule run your_analysis.script
      	
      	#run from a certain step
      	seqmule run -n 10 your_analysis.script

      	#run via Sun Grid Engine (a job scheduling system)
      	seqmule run -sge "qsub -V -cwd -pe smp XCPUX" your_analysis.script

=head1 DETAILS

=over 8

=item B<--sge>

To run commands via Sun Grid Engine, SGE must be installed first. -e, -o will be added automatically. "-S /bin/bash" is added automatically. Do NOT specify -e,-o or -S in the qsub template.

=back

=cut
